version: '3'

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  # --------------------------------------------------------------------------
  # Start services
  # --------------------------------------------------------------------------
  up:
    desc: Start all production services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

  up-dev:
    desc: Start all development services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
      - cmd: 'echo "Development services started:"'
        silent: true
      - cmd: 'echo "  - Server (dev): http://localhost:5000"'
        silent: true
      - cmd: 'echo "  - Client (dev): http://localhost:3000"'
        silent: true
      - cmd: 'echo "  - MinIO Console: http://localhost:9001"'
        silent: true
      - cmd: 'echo "  - PostgreSQL: localhost:5432"'
        silent: true

  up-elk:
    desc: Start ELK stack services
    cmds:
      - docker compose -f docker-compose.elk.yml up -d
      - cmd: 'echo "ELK stack started:"'
        silent: true
      - cmd: 'echo "  - Elasticsearch: http://localhost:9200"'
        silent: true
      - cmd: 'echo "  - Kibana: http://localhost:5601"'
        silent: true

  up-infra:
    desc: Start infrastructure services only (Postgres, MinIO, Ollama)
    cmds:
      - docker compose -f docker-compose.yml up -d postgres minio ollama
      - cmd: 'echo "Waiting for Ollama to be healthy..."'
        silent: true
      - docker compose -f docker-compose.yml up ollama-setup
      - cmd: 'echo "Infrastructure services started."'
        silent: true

  down:
    desc: Stop all services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.dev.yml -f docker-compose.elk.yml down

  # --------------------------------------------------------------------------
  # Restart services
  # --------------------------------------------------------------------------
  restart:
    desc: Restart production services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml restart

  restart-dev:
    desc: Restart development services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml restart

  # --------------------------------------------------------------------------
  # Show status
  # --------------------------------------------------------------------------
  ps:
    desc: Show status of all services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.dev.yml -f docker-compose.elk.yml ps

  # --------------------------------------------------------------------------
  # Build images
  # --------------------------------------------------------------------------
  build:
    desc: Build all production images
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml build

  build-dev:
    desc: Build all development images
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml build

  build-server:
    desc: Build server production image
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml build server-prod

  build-server-dev:
    desc: Build server development image
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml build server-dev

  build-client:
    desc: Build client production image
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml build client-prod

  build-client-dev:
    desc: Build client development image
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml build client-dev

  clean:
    desc: Remove all containers, images, and volumes
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.dev.yml -f docker-compose.elk.yml down -v --rmi all
      - task: server:clean
      - task: client:clean

  # --------------------------------------------------------------------------
  # Logs
  # --------------------------------------------------------------------------
  logs:
    desc: Show logs from all services
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.dev.yml -f docker-compose.elk.yml logs -f

  logs-server:
    desc: Show server logs (production)
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f server-prod

  logs-server-dev:
    desc: Show server logs (development)
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml logs -f server-dev

  logs-client:
    desc: Show client logs (production)
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f client-prod

  logs-client-dev:
    desc: Show client logs (development)
    cmds:
      - docker compose -f docker-compose.yml -f docker-compose.dev.yml logs -f client-dev

  logs-elk:
    desc: Show ELK logs
    cmds:
      - docker compose -f docker-compose.elk.yml logs -f

  logs-ollama:
    desc: Show Ollama logs
    cmds:
      - docker compose -f docker-compose.yml logs -f ollama

  logs-postgres:
    desc: Show Postgres logs
    cmds:
      - docker compose -f docker-compose.yml logs -f postgres

  logs-minio:
    desc: Show MinIO logs
    cmds:
      - docker compose -f docker-compose.yml logs -f minio

  # --------------------------------------------------------------------------
  # Dev shortcuts
  # --------------------------------------------------------------------------
  dev-server:
    desc: Run server in development mode
    cmds:
      - task: server:server

  dev-client:
    desc: Run client in development mode
    cmds:
      - task: client:dev

  # --------------------------------------------------------------------------
  # Subdirectory tasks
  # --------------------------------------------------------------------------
  server:*:
    desc: Run server tasks (use task server:<task-name>)
    dir: packages/server
    cmds:
      - task {{index .MATCH 0}}

  client:*:
    desc: Run client tasks (use task client:<task-name>)
    dir: packages/client
    cmds:
      - task {{index .MATCH 0}}

  check:
    desc: Run all checks for both client and server
    cmds:
      - cmd: echo "Running server checks..."
        silent: true
      - task: server:check
      - cmd: echo ""
        silent: true
      - cmd: echo "Running client checks..."
        silent: true
      - task: client:check
      - cmd: echo ""
        silent: true
      - cmd: echo "All checks passed!"
        silent: true

  # --------------------------------------------------------------------------
  # Security tasks (root level)
  # --------------------------------------------------------------------------
  audit:
    desc: Run dependency audits for client and server
    cmds:
      - cmd: echo "Running server audit..."
        silent: true
      - task: server:audit
      - cmd: echo ""
        silent: true
      - cmd: echo "Running client audit..."
        silent: true
      - task: client:audit
      - cmd: echo ""
        silent: true
      - cmd: echo "Audit complete!"
        silent: true

  scan:
    desc: Run code scans for client and server
    cmds:
      - cmd: echo "Running server scan..."
        silent: true
      - task: server:scan
      - cmd: echo ""
        silent: true
      - cmd: echo "Running client scan..."
        silent: true
      - task: client:scan
      - cmd: echo ""
        silent: true
      - cmd: echo "Scan complete!"
        silent: true

  security:
    desc: Run full security checks (audit + scan + Docker image scans)
    cmds:
      - cmd: echo "Running audits..."
        silent: true
      - task: audit
      - cmd: echo "Running code scans..."
        silent: true
      - task: scan
      - cmd: echo "Building Docker images before scanning..."
        silent: true
      - docker compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.dev.yml build client-prod client-dev server-prod server-dev
      - cmd: echo "Scanning Docker images..."
        silent: true
      - cmd: |
          IMAGES=("client-prod" "client-dev" "server-prod" "server-dev")
          for IMAGE in "${IMAGES[@]}"; do
            if docker image inspect insighthub-$IMAGE > /dev/null 2>&1; then
              echo "Scanning image: insighthub-$IMAGE"
              # Scan with Trivy and output JSON for CI/CD
              trivy image insighthub-$IMAGE --ignore-unfixed --format json --output trivy-$IMAGE.json
            else
              echo "Image insighthub-$IMAGE does not exist, skipping..."
            fi
          done
      - cmd: echo "Full security check complete!"
        silent: true
