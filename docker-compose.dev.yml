services:
  server-dev:
    labels:
      project: insighthub
    image: insighthub-server:dev
    container_name: insighthub-server-dev
    profiles:
      - dev
    restart: unless-stopped
    build:
      context: ./packages/server
      dockerfile: Dockerfile
      target: development
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '5000:8000'
    volumes:
      - ./packages/server/src:/app/src:ro
      - ./packages/server/tests:/app/tests:ro
      - ./packages/server/pyproject.toml:/app/pyproject.toml:ro
      - ./packages/server/poetry.lock:/app/poetry.lock:ro
      - ./packages/shared/python/src/shared:/app/.venv/lib/python3.11/site-packages/shared:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  client-dev:
    labels:
      project: insighthub
    image: insighthub-client:dev
    container_name: insighthub-client-dev
    profiles:
      - dev
    restart: unless-stopped
    build:
      context: ./packages/client
      dockerfile: Dockerfile
      target: development
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '3000:5173'
    volumes:
      - ./packages/client/src:/app/src:ro
      - ./packages/client/public:/app/public:ro
      - ./packages/client/index.html:/app/index.html:ro
      - ./packages/client/vite.config.ts:/app/vite.config.ts:ro
      - ./packages/client/tsconfig.json:/app/tsconfig.json:ro
      - ./packages/client/tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./packages/client/package.json:/app/package.json:ro
      - ./packages/client/bun.lockb:/app/bun.lockb:ro
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:5000
    depends_on:
      server-dev:
        condition: service_started
    networks:
      - insighthub

  # ============================================================================
  # Development Workers - Background processing with hot-reload
  # ============================================================================

  worker-parser-dev:
    labels:
      project: insighthub
      worker: parser
    image: insighthub-worker-parser:dev
    container_name: insighthub-worker-parser-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/parser/Dockerfile
      target: development
    volumes:
      - ./packages/workers/parser/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: parser
      WORKER_CONCURRENCY: 4
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-chucker-dev:
    labels:
      project: insighthub
      worker: chucker
    image: insighthub-worker-chucker:dev
    container_name: insighthub-worker-chucker-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/chucker/Dockerfile
      target: development
    volumes:
      - ./packages/workers/chucker/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: chucker
      WORKER_CONCURRENCY: 4
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-embedder-dev:
    labels:
      project: insighthub
      worker: embedder
    image: insighthub-worker-embedder:dev
    container_name: insighthub-worker-embedder-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/embedder/Dockerfile
      target: development
    volumes:
      - ./packages/workers/embedder/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: embedder
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-indexer-dev:
    labels:
      project: insighthub
      worker: indexer
    image: insighthub-worker-indexer:dev
    container_name: insighthub-worker-indexer-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/indexer/Dockerfile
      target: development
    volumes:
      - ./packages/workers/indexer/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: indexer
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-connector-dev:
    labels:
      project: insighthub
      worker: connector
    image: insighthub-worker-connector:dev
    container_name: insighthub-worker-connector-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/connector/Dockerfile
      target: development
    volumes:
      - ./packages/workers/connector/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: connector
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-enricher-dev:
    labels:
      project: insighthub
      worker: enricher
    image: insighthub-worker-enricher:dev
    container_name: insighthub-worker-enricher-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/enricher/Dockerfile
      target: development
    volumes:
      - ./packages/workers/enricher/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: enricher
      WORKER_CONCURRENCY: 3
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-chat-dev:
    labels:
      project: insighthub
      worker: chat
    image: insighthub-worker-chat:dev
    container_name: insighthub-worker-chat-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/chat/Dockerfile
      target: development
    volumes:
      - ./packages/workers/chat/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: chat
      WORKER_CONCURRENCY: 5
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-deletion-dev:
    labels:
      project: insighthub
      worker: deletion
    image: insighthub-worker-deletion:dev
    container_name: insighthub-worker-deletion-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/deletion/Dockerfile
      target: development
    volumes:
      - ./packages/workers/deletion/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: deletion
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-provisioner-dev:
    labels:
      project: insighthub
      worker: provisioner
    image: insighthub-worker-provisioner:dev
    container_name: insighthub-worker-provisioner-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/provisioner/Dockerfile
      target: development
    volumes:
      - ./packages/workers/provisioner/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: provisioner
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-wikipedia-dev:
    labels:
      project: insighthub
      worker: wikipedia
    image: insighthub-worker-wikipedia:dev
    container_name: insighthub-worker-wikipedia-dev
    profiles:
      - dev
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/wikipedia/Dockerfile
      target: development
    volumes:
      - ./packages/workers/wikipedia/src:/app/src:ro
      - ./infra/config/.env.development:/app/.env.development:ro
    env_file:
      - ./infra/config/.env.development
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_NAME: wikipedia
      WORKER_CONCURRENCY: 2
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub
