services:
  server-dev:
    labels:
      project: insighthub
    image: insighthub-server:dev
    container_name: insighthub-server-dev
    profiles:
      - dev
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/server/Dockerfile
      target: development
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '5000:8000'
    environment:
      # Python
      PYTHONUNBUFFERED: 1
      # Flask
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 8000
      FLASK_ENV: production
      # Database
      DATABASE_URL: postgresql://insighthub:insighthub_dev@postgres:5432/insighthub
      # Storage
      BLOB_STORAGE_TYPE: s3
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: insighthub
      S3_SECRET_KEY: insighthub_dev_secret
      S3_BUCKET_NAME: documents
      # LLM
      LLM_PROVIDER: ollama
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_LLM_MODEL: llama3.2:1b
      OLLAMA_EMBEDDING_MODEL: nomic-embed-text
      # Vector Store
      QDRANT_URL: http://qdrant:6333
      QDRANT_COLLECTION_NAME: documents
      # Cache
      REDIS_URL: redis://redis:6379/0
      # Message Queue
      RABBITMQ_URL: amqp://insighthub:insighthub_dev@rabbitmq:5672/
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  client-dev:
    labels:
      project: insighthub
    image: insighthub-client:dev
    container_name: insighthub-client-dev
    profiles:
      - dev
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/client/Dockerfile
      target: development
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '3000:80'
    environment:
      VITE_API_URL: http://localhost:5000
      NGINX_PORT: 80
    depends_on:
      server-prod:
        condition: service_started
    networks:
      - insighthub
