services:
  server-prod:
    labels:
      project: insighthub
    image: insighthub-server:prod
    container_name: insighthub-server-prod
    profiles:
      - prod
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/server/Dockerfile
      target: production
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '5000:8000'
    environment:
      # Python
      PYTHONUNBUFFERED: 1
      # Flask
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 8000
      FLASK_ENV: production
      # Database
      DATABASE_URL: postgresql://insighthub:insighthub_dev@postgres:5432/insighthub
      # Storage
      BLOB_STORAGE_TYPE: s3
      S3_ENDPOINT_URL: http://minio:9000
      S3_ACCESS_KEY: insighthub
      S3_SECRET_KEY: insighthub_dev_secret
      S3_BUCKET_NAME: documents
      # LLM
      LLM_PROVIDER: ollama
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_LLM_MODEL: llama3.2:1b
      OLLAMA_EMBEDDING_MODEL: nomic-embed-text
      # Vector Store
      QDRANT_URL: http://qdrant:6333
      QDRANT_COLLECTION_NAME: documents
      # Cache
      REDIS_URL: redis://redis:6379/0
      # Message Queue
      RABBITMQ_URL: amqp://insighthub:insighthub_dev@rabbitmq:5672/
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      ollama:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  client-prod:
    labels:
      project: insighthub
    image: insighthub-client:prod
    container_name: insighthub-client-prod
    profiles:
      - prod
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/client/Dockerfile
      target: production
      args:
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - '3000:80'
    environment:
      VITE_API_URL: http://localhost:5000
      NGINX_PORT: 80
    depends_on:
      server-prod:
        condition: service_started
    networks:
      - insighthub

  # ============================================================================
  # Production Workers - Background processing (optimized)
  # ============================================================================

  worker-chat-prod:
    labels:
      project: insighthub
      worker: chat
    image: insighthub-worker-chat:prod
    container_name: insighthub-worker-chat-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/chat/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      WORKER_NAME: chat
      WORKER_CONCURRENCY: ${CHAT_WORKER_CONCURRENCY:-5}
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-parser-prod:
    labels:
      project: insighthub
      worker: parser
    image: insighthub-worker-parser:prod
    container_name: insighthub-worker-parser-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/parser/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      MINIO_ENDPOINT_URL: ${MINIO_ENDPOINT_URL:-http://minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-insighthub}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-insighthub_dev_secret}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-documents}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: parser
      WORKER_CONCURRENCY: ${PARSER_WORKER_CONCURRENCY:-4}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-chucker-prod:
    labels:
      project: insighthub
      worker: chucker
    image: insighthub-worker-chucker:prod
    container_name: insighthub-worker-chucker-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/chunker/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: chucker
      WORKER_CONCURRENCY: ${CHUCKER_WORKER_CONCURRENCY:-4}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      CHUNK_OVERLAP: ${CHUNK_OVERLAP:-200}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-connector-prod:
    labels:
      project: insighthub
      worker: connector
    image: insighthub-worker-connector:prod
    container_name: insighthub-worker-connector-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/graph/connector/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      NEO4J_URL: ${NEO4J_URL:-bolt://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-insighthub_dev}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: connector
      WORKER_CONCURRENCY: ${CONNECTOR_WORKER_CONCURRENCY:-2}
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-enricher-prod:
    labels:
      project: insighthub
      worker: enricher
    image: insighthub-worker-enricher:prod
    container_name: insighthub-worker-enricher-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/enricher/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      SEMANTIC_SCHOLAR_API_KEY: ${SEMANTIC_SCHOLAR_API_KEY:-}
      WORKER_NAME: enricher
      WORKER_CONCURRENCY: ${ENRICHER_WORKER_CONCURRENCY:-3}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-wikipedia-prod:
    labels:
      project: insighthub
      worker: wikipedia
    image: insighthub-worker-wikipedia:prod
    container_name: insighthub-worker-wikipedia-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/wikipedia/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      MINIO_ENDPOINT_URL: ${MINIO_ENDPOINT_URL:-http://minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-insighthub}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-insighthub_dev_secret}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-documents}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: wikipedia
      WORKER_CONCURRENCY: ${WIKIPEDIA_WORKER_CONCURRENCY:-2}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-infrastructure-manager-prod:
    labels:
      project: insighthub
      worker: infrastructure-manager
    image: insighthub-worker-infrastructure-manager:prod
    container_name: insighthub-worker-infrastructure-manager-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/infrastructure-manager/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: infrastructure_manager
      WORKER_CONCURRENCY: ${INFRASTRUCTURE_MANAGER_WORKER_CONCURRENCY:-1}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-router-prod:
    labels:
      project: insighthub
      worker: router
    image: insighthub-worker-router:prod
    container_name: insighthub-worker-router-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/general/router/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      WORKER_NAME: router
      WORKER_CONCURRENCY: ${ROUTER_WORKER_CONCURRENCY:-2}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

  worker-vector-processor-prod:
    labels:
      project: insighthub
      worker: vector-processor
    image: insighthub-worker-vector-processor:prod
    container_name: insighthub-worker-vector-processor-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/vector/processor/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION_NAME: ${QDRANT_COLLECTION_NAME:-documents}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      WORKER_NAME: vector_processor
      WORKER_CONCURRENCY: ${VECTOR_PROCESSOR_WORKER_CONCURRENCY:-3}
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub

   # worker-graph-preprocessor-prod:
   #   labels:
   #     project: insighthub
   #     worker: graph-preprocessor
   #   image: insighthub-worker-graph-preprocessor:prod
   #   container_name: insighthub-worker-graph-preprocessor-prod
   #   profiles:
   #     - prod
   #     - workers
   #   restart: unless-stopped
   #   build:
   #     context: .
   #     dockerfile: packages/workers/graph/preprocessor/Dockerfile
   #     target: production
   #   environment:
   #     PYTHONUNBUFFERED: 1
   #     DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
   #     NEO4J_URL: ${NEO4J_URL:-bolt://neo4j:7687}
   #     NEO4J_USER: ${NEO4J_USER:-neo4j}
   #     NEO4J_PASSWORD: ${NEO4J_PASSWORD:-insighthub_dev}
   #     RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
   #     RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
   #     OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
   #     OLLAMA_LLM_MODEL: ${OLLAMA_LLM_MODEL:-llama3.2:1b}
   #     WORKER_NAME: graph_preprocessor
   #     WORKER_CONCURRENCY: ${GRAPH_PREPROCESSOR_WORKER_CONCURRENCY:-2}
   #   depends_on:
   #     postgres:
   #       condition: service_healthy
   #     neo4j:
   #       condition: service_healthy
   #     ollama:
   #       condition: service_healthy
   #     rabbitmq:
   #       condition: service_healthy
   #   networks:
   #     - insighthub

   # worker-graph-construction-prod:
   #   labels:
   #     project: insighthub
   #     worker: graph-construction
   #   image: insighthub-worker-graph-construction:prod
   #   container_name: insighthub-worker-graph-construction-prod
   #   profiles:
   #     - prod
   #     - workers
   #   restart: unless-stopped
   #   build:
   #     context: .
   #     dockerfile: packages/workers/graph/construction/Dockerfile
   #     target: production
   #   environment:
   #     PYTHONUNBUFFERED: 1
   #     DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
   #     NEO4J_URL: ${NEO4J_URL:-bolt://neo4j:7687}
   #     NEO4J_USER: ${NEO4J_USER:-neo4j}
   #     NEO4J_PASSWORD: ${NEO4J_PASSWORD:-insighthub_dev}
   #     RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
   #     RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
   #     WORKER_NAME: graph_construction
   #     WORKER_CONCURRENCY: ${GRAPH_CONSTRUCTION_WORKER_CONCURRENCY:-2}
   #   depends_on:
   #     postgres:
   #       condition: service_healthy
   #     neo4j:
   #       condition: service_healthy
   #     rabbitmq:
   #       condition: service_healthy
   #   networks:
   #     - insighthub

   # worker-graph-query-prod:
   #   labels:
   #     project: insighthub
   #     worker: graph-query
   #   image: insighthub-worker-graph-query:prod
   #   container_name: insighthub-worker-graph-query-prod
   #   profiles:
   #     - prod
   #     - workers
   #   restart: unless-stopped
   #   build:
   #     context: .
   #     dockerfile: packages/workers/graph/query/Dockerfile
   #     target: production
   #   environment:
   #     PYTHONUNBUFFERED: 1
   #     DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
   #     NEO4J_URL: ${NEO4J_URL:-bolt://neo4j:7687}
   #     NEO4J_USER: ${NEO4J_USER:-neo4j}
   #     NEO4J_PASSWORD: ${NEO4J_PASSWORD:-insighthub_dev}
   #     RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
   #     RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
   #     OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
   #     OLLAMA_LLM_MODEL: ${OLLAMA_LLM_MODEL:-llama3.2:1b}
   #     WORKER_NAME: graph_query
   #     WORKER_CONCURRENCY: ${GRAPH_QUERY_WORKER_CONCURRENCY:-3}
   #   depends_on:
   #     postgres:
   #       condition: service_healthy
   #     neo4j:
   #       condition: service_healthy
   #     ollama:
   #       condition: service_healthy
   #     rabbitmq:
   #       condition: service_healthy
   #   networks:
   #     - insighthub

  worker-vector-query-prod:
    labels:
      project: insighthub
      worker: vector-query
    image: insighthub-worker-vector-query:prod
    container_name: insighthub-worker-vector-query-prod
    profiles:
      - prod
      - workers
    restart: unless-stopped
    build:
      context: .
      dockerfile: packages/workers/vector/query/Dockerfile
      target: production
    environment:
      PYTHONUNBUFFERED: 1
      DATABASE_URL: ${DATABASE_URL:-postgresql://insighthub:insighthub_dev@postgres:5432/insighthub}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION_NAME: ${QDRANT_COLLECTION_NAME:-documents}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://insighthub:insighthub_dev@rabbitmq:5672/}
      RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE:-insighthub}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      WORKER_NAME: vector_query
      WORKER_CONCURRENCY: ${VECTOR_QUERY_WORKER_CONCURRENCY:-4}
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - insighthub


