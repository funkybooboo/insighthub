openapi: 3.0.3
info:
  title: InsightHub RAG API
  description: |
    RESTful API for InsightHub - A Retrieval-Augmented Generation (RAG) system with vector and graph implementations.

    This API provides endpoints for:
    - User authentication and authorization
    - Document upload and management
    - Chat interactions with AI using RAG
    - Health and metrics monitoring
  version: 0.1.0
  contact:
    name: Nate Stott
  license:
    name: MIT

servers:
  - url: http://localhost:5000
    description: Local development server
  - url: https://api.insighthub.example.com
    description: Production server

tags:
  - name: Health
    description: Health check and monitoring endpoints
  - name: Authentication
    description: User authentication and authorization
  - name: Documents
    description: Document upload and management
  - name: Chat
    description: Chat interactions with RAG system

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/auth/login or /api/auth/signup

  schemas:
    User:
      type: object
      required:
        - id
        - username
        - email
        - created_at
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: "johndoe"
        email:
          type: string
          format: email
          example: "john@example.com"
        full_name:
          type: string
          nullable: true
          example: "John Doe"
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    AuthResponse:
      type: object
      required:
        - access_token
        - token_type
        - user
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          example: "bearer"
        user:
          $ref: '#/components/schemas/User'

    Document:
      type: object
      required:
        - id
        - filename
        - file_size
        - mime_type
        - created_at
      properties:
        id:
          type: integer
          example: 1
        filename:
          type: string
          example: "research-paper.pdf"
        file_size:
          type: integer
          format: int64
          example: 1048576
          description: File size in bytes
        mime_type:
          type: string
          example: "application/pdf"
        chunk_count:
          type: integer
          example: 42
          description: Number of chunks the document was split into
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    ChatContext:
      type: object
      required:
        - text
        - score
        - metadata
      properties:
        text:
          type: string
          description: Retrieved context text from documents
          example: "Machine learning is a subset of artificial intelligence..."
        score:
          type: number
          format: float
          example: 0.95
          description: Relevance score (0-1)
        metadata:
          type: object
          additionalProperties: true
          example:
            source: "ml-textbook.pdf"
            page: 42

    ChatResponse:
      type: object
      required:
        - answer
        - context
        - session_id
        - documents_count
      properties:
        answer:
          type: string
          description: AI-generated response
          example: "Machine learning is a method of data analysis..."
        context:
          type: array
          items:
            $ref: '#/components/schemas/ChatContext'
        session_id:
          type: integer
          example: 1
        documents_count:
          type: integer
          example: 5
          description: Number of documents available for RAG

    ChatSession:
      type: object
      required:
        - id
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          example: 1
        title:
          type: string
          nullable: true
          example: "Discussion about ML"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ChatMessage:
      type: object
      required:
        - id
        - session_id
        - role
        - content
        - created_at
      properties:
        id:
          type: integer
          example: 1
        session_id:
          type: integer
          example: 1
        role:
          type: string
          enum: [user, assistant]
          example: "user"
        content:
          type: string
          example: "What is machine learning?"
        created_at:
          type: string
          format: date-time

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          example: "Resource not found"

    HealthStatus:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          example: "healthy"

paths:
  /heartbeat:
    get:
      tags:
        - Health
      summary: Simple heartbeat check
      description: Returns 200 OK with no body for basic health checking
      responses:
        '200':
          description: Service is alive

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns health status of the service
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /metrics:
    get:
      tags:
        - Health
      summary: Application metrics
      description: Get application metrics and performance statistics
      responses:
        '200':
          description: Metrics data
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                properties:
                  status:
                    type: string
                  performance:
                    type: object
                    additionalProperties: true

  /api/auth/signup:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Create a new user account and receive a JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  example: "johndoe"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  minLength: 6
                  format: password
                  example: "SecurePass123!"
                full_name:
                  type: string
                  example: "John Doe"
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error or user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate with username and password to receive a JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "johndoe"
                password:
                  type: string
                  format: password
                  example: "SecurePass123!"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get the authenticated user's information
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: |
        Logout endpoint (client-side token removal).
        With stateless JWT, logout is handled client-side by removing the token.
        This endpoint is provided for consistency.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Successfully logged out"

  /api/documents/upload:
    post:
      tags:
        - Documents
      summary: Upload a document
      description: Upload a PDF or TXT document for RAG processing
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: PDF or TXT file
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Document uploaded successfully"
                  document:
                    $ref: '#/components/schemas/Document'
        '200':
          description: Document already exists (duplicate)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Document already exists"
                  document:
                    $ref: '#/components/schemas/Document'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/documents:
    get:
      tags:
        - Documents
      summary: List documents
      description: Get all documents uploaded by the authenticated user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  documents:
                    type: array
                    items:
                      $ref: '#/components/schemas/Document'
                  count:
                    type: integer
                    example: 5
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/documents/{doc_id}:
    delete:
      tags:
        - Documents
      summary: Delete a document
      description: Delete a document and remove it from the RAG system
      security:
        - BearerAuth: []
      parameters:
        - name: doc_id
          in: path
          required: true
          schema:
            type: integer
          description: Document ID
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Document deleted successfully"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/chat:
    post:
      tags:
        - Chat
      summary: Send a chat message
      description: Send a message and get an AI response using RAG
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                  example: "What is machine learning?"
                session_id:
                  type: integer
                  nullable: true
                  example: 1
                  description: Optional session ID to continue a conversation
                rag_type:
                  type: string
                  enum: [vector, graph]
                  default: vector
                  example: "vector"
                  description: Type of RAG to use
      responses:
        '200':
          description: Chat response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/sessions:
    get:
      tags:
        - Chat
      summary: List chat sessions
      description: Get all chat sessions for the authenticated user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatSession'
                  count:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/sessions/{session_id}/messages:
    get:
      tags:
        - Chat
      summary: Get session messages
      description: Get all messages for a specific chat session
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: integer
          description: Session ID
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatMessage'
                  count:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
