"""Integration tests for async chat processing pipeline."""

import json

import pytest
from flask.testing import FlaskClient

pytest.skip(
    "Temporarily skipping chat integration tests due to testcontainer setup issues",
    allow_module_level=True,
)


def test_async_chat_message_processing(client: FlaskClient, auth_token: str):
    """Test the full async chat message processing pipeline."""
    # This test would require RabbitMQ and the chat worker to be running
    # For now, we'll test the synchronous fallback

    message_data = {
        "content": "What is machine learning?",
        "message_type": "user",
        "ignore_rag": False,
    }

    response = client.post(
        "/api/workspaces/1/chat/sessions/1/messages",
        data=json.dumps(message_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 200
    data = json.loads(response.data)
    assert "message_id" in data


def test_chat_session_workspace_association(client: FlaskClient, auth_token: str):
    """Test that chat sessions are properly associated with workspaces."""
    # Create a session in workspace 1
    session_data = {"title": "Workspace 1 Session"}
    response = client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps(session_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 201
    session_data = json.loads(response.data)
    session_id = session_data["session_id"]

    # Verify the session belongs to workspace 1
    response = client.get(
        f"/api/workspaces/1/chat/sessions/{session_id}",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 200
    data = json.loads(response.data)
    assert data["session_id"] == session_id
    assert data["title"] == "Workspace 1 Session"


def test_chat_session_workspace_isolation(client: FlaskClient, auth_token: str):
    """Test that sessions are properly isolated between workspaces."""
    # Create session in workspace 1
    session_data = {"title": "Workspace 1 Session"}
    response = client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps(session_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 201
    session_data = json.loads(response.data)
    session_id = session_data["session_id"]

    # Try to access the same session from workspace 2 (should fail)
    response = client.get(
        f"/api/workspaces/2/chat/sessions/{session_id}",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 404


def test_chat_session_update(client: FlaskClient, auth_token: str):
    """Test updating chat session properties."""
    # Create a session
    session_data = {"title": "Original Title"}
    response = client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps(session_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 201
    session_data = json.loads(response.data)
    session_id = session_data["session_id"]

    # Update the session title
    update_data = {"title": "Updated Title"}
    response = client.patch(
        f"/api/workspaces/1/chat/sessions/{session_id}",
        data=json.dumps(update_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 200
    data = json.loads(response.data)
    assert data["title"] == "Updated Title"


def test_chat_session_listing_workspace_scoped(client: FlaskClient, auth_token: str):
    """Test that session listing is properly scoped to workspaces."""
    # Create sessions in different workspaces
    client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps({"title": "Workspace 1 Session 1"}),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps({"title": "Workspace 1 Session 2"}),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    client.post(
        "/api/workspaces/2/chat/sessions",
        data=json.dumps({"title": "Workspace 2 Session"}),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    # List sessions in workspace 1
    response = client.get(
        "/api/workspaces/1/chat/sessions", headers={"Authorization": f"Bearer {auth_token}"}
    )

    assert response.status_code == 200
    data = json.loads(response.data)
    assert len(data) >= 2  # Should have at least the 2 sessions we created

    # Verify all returned sessions belong to workspace 1
    for session in data:
        # Get individual session to verify workspace association
        detail_response = client.get(
            f"/api/workspaces/1/chat/sessions/{session['session_id']}",
            headers={"Authorization": f"Bearer {auth_token}"},
        )
        assert detail_response.status_code == 200


def test_chat_session_deletion(client: FlaskClient, auth_token: str):
    """Test chat session deletion."""
    # Create a session
    session_data = {"title": "Session to Delete"}
    response = client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps(session_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 201
    session_data = json.loads(response.data)
    session_id = session_data["session_id"]

    # Delete the session
    response = client.delete(
        f"/api/workspaces/1/chat/sessions/{session_id}",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 200

    # Verify session is gone
    response = client.get(
        f"/api/workspaces/1/chat/sessions/{session_id}",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 404


def test_chat_message_validation(client: FlaskClient, auth_token: str):
    """Test chat message input validation."""
    # Test empty content
    message_data = {"content": "", "message_type": "user"}
    response = client.post(
        "/api/workspaces/1/chat/sessions/1/messages",
        data=json.dumps(message_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 400

    # Test missing content
    message_data = {"message_type": "user"}
    response = client.post(
        "/api/workspaces/1/chat/sessions/1/messages",
        data=json.dumps(message_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 400

    # Test invalid message type
    message_data = {"content": "Hello", "message_type": "invalid"}
    response = client.post(
        "/api/workspaces/1/chat/sessions/1/messages",
        data=json.dumps(message_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 400


def test_workspace_access_control(client: FlaskClient, auth_token: str):
    """Test that workspace access control works for chat operations."""
    # Try to access workspace that user doesn't have access to
    response = client.post(
        "/api/workspaces/999/chat/sessions",
        data=json.dumps({"title": "Unauthorized Session"}),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 403

    # Try to list sessions in unauthorized workspace
    response = client.get(
        "/api/workspaces/999/chat/sessions", headers={"Authorization": f"Bearer {auth_token}"}
    )

    assert response.status_code == 403


@pytest.mark.parametrize(
    "endpoint,method,data",
    [
        ("/api/workspaces/1/chat/sessions", "POST", {"title": "Test"}),
        ("/api/workspaces/1/chat/sessions", "GET", None),
        ("/api/workspaces/1/chat/sessions/1", "GET", None),
        ("/api/workspaces/1/chat/sessions/1", "PATCH", {"title": "Updated"}),
        ("/api/workspaces/1/chat/sessions/1", "DELETE", None),
        (
            "/api/workspaces/1/chat/sessions/1/messages",
            "POST",
            {"content": "Hello", "message_type": "user"},
        ),
    ],
)
def test_chat_endpoints_require_authentication(
    client: FlaskClient, endpoint: str, method: str, data
):
    """Test that all chat endpoints require authentication."""
    if method == "GET":
        response = client.get(endpoint)
    elif method == "POST":
        response = client.post(endpoint, json=data)
    elif method == "PATCH":
        response = client.patch(endpoint, json=data)
    elif method == "DELETE":
        response = client.delete(endpoint)

    assert response.status_code == 401


def test_chat_session_pagination(client: FlaskClient, auth_token: str):
    """Test chat session listing pagination."""
    # Create multiple sessions
    for i in range(5):
        client.post(
            "/api/workspaces/1/chat/sessions",
            data=json.dumps({"title": f"Session {i}"}),
            content_type="application/json",
            headers={"Authorization": f"Bearer {auth_token}"},
        )

    # Test pagination
    response = client.get(
        "/api/workspaces/1/chat/sessions?limit=2&offset=1",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    assert response.status_code == 200
    data = json.loads(response.data)
    assert len(data) <= 2  # Should respect limit


def test_chat_session_message_count(client: FlaskClient, auth_token: str):
    """Test that session listing includes accurate message counts."""
    # Create a session
    response = client.post(
        "/api/workspaces/1/chat/sessions",
        data=json.dumps({"title": "Session with Messages"}),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    session_data = json.loads(response.data)
    session_id = session_data["session_id"]

    # Send a message to the session
    message_data = {"content": "Test message", "message_type": "user"}
    client.post(
        f"/api/workspaces/1/chat/sessions/{session_id}/messages",
        data=json.dumps(message_data),
        content_type="application/json",
        headers={"Authorization": f"Bearer {auth_token}"},
    )

    # Check that session listing shows correct message count
    response = client.get(
        "/api/workspaces/1/chat/sessions", headers={"Authorization": f"Bearer {auth_token}"}
    )

    data = json.loads(response.data)
    session_info = next((s for s in data if s["session_id"] == session_id), None)
    assert session_info is not None
    assert session_info["message_count"] >= 1  # Should have at least the message we sent
